<Project>

  <!-- ========================================== -->
  <!-- POWERSHELL 7.5.2 MANDATORY BUILD VALIDATION -->
  <!-- ========================================== -->

  <PropertyGroup>
    <PowerShellSyntaxEnforcerPath>$(MSBuildThisFileDirectory)\Tools\Scripts\PowerShell-7.5.2-Syntax-Enforcer.ps1</PowerShellSyntaxEnforcerPath>
    <PowerShellValidationRequired>false</PowerShellValidationRequired>
    <PowerShellValidationFailOnError>false</PowerShellValidationFailOnError>
    <PowerShellProgressiveMode>true</PowerShellProgressiveMode> <!-- Progressive: Only validate new scripts -->
  </PropertyGroup>

  <!-- Define PowerShell files to validate -->
  <ItemGroup>
    <PowerShellScripts Include="**/*.ps1" Exclude="bin/**;obj/**;packages/**" />
    <PowerShellModules Include="**/*.psm1" Exclude="bin/**;obj/**;packages/**" />
    <PowerShellProfiles Include="**/BusBuddy-*.ps1" />
  </ItemGroup>

  <!-- ========================================== -->
  <!-- MANDATORY POWERSHELL VALIDATION TARGET -->
  <!-- ========================================== -->

  <Target Name="ValidatePowerShellSyntax" BeforeTargets="Build" Condition="'$(PowerShellValidationRequired)' == 'true'">

    <Message Text="ðŸ”’ Enforcing PowerShell 7.5.2 syntax requirements..." Importance="high" />

    <!-- Check if syntax enforcer exists -->
    <Error Condition="!Exists('$(PowerShellSyntaxEnforcerPath)')"
           Text="PowerShell 7.5.2 Syntax Enforcer not found at: $(PowerShellSyntaxEnforcerPath)" />

    <!-- Run syntax validation with progressive mode (legacy exemption enabled) -->
    <Exec Command="pwsh.exe -ExecutionPolicy Bypass -File &quot;$(PowerShellSyntaxEnforcerPath)&quot; -Path &quot;$(MSBuildProjectDirectory)&quot; -LegacyExemption -ExitOnFail"
          ContinueOnError="false"
          Condition="'$(PowerShellValidationFailOnError)' == 'true'" />

    <Message Text="âœ… PowerShell 7.5.2 syntax validation completed successfully" Importance="high" />

  </Target>

  <!-- ========================================== -->
  <!-- POWERSHELL TEMPLATE CREATION TARGET -->
  <!-- ========================================== -->

  <Target Name="CreatePowerShellTemplate">

    <Message Text="ðŸ“ Creating PowerShell 7.5.2 compliant template..." Importance="high" />

    <Exec Command="pwsh.exe -ExecutionPolicy Bypass -File &quot;$(PowerShellSyntaxEnforcerPath)&quot; -CreateTemplate -TemplateName &quot;$(TemplateName)&quot;"
          ContinueOnError="false" />

    <Message Text="âœ… PowerShell template created successfully" Importance="high" />

  </Target>

  <!-- ========================================== -->
  <!-- POWERSHELL SYNTAX CHECK TARGET (Manual) -->
  <!-- ========================================== -->

  <Target Name="CheckPowerShellSyntax">

    <Message Text="ðŸ” Running PowerShell 7.5.2 syntax check..." Importance="high" />

    <Exec Command="pwsh.exe -ExecutionPolicy Bypass -File &quot;$(PowerShellSyntaxEnforcerPath)&quot; -Path &quot;$(MSBuildProjectDirectory)&quot; -Verbose"
          ContinueOnError="true" />

  </Target>

  <!-- ========================================== -->
  <!-- POWERSHELL VALIDATION SUMMARY -->
  <!-- ========================================== -->

  <Target Name="PowerShellValidationSummary" AfterTargets="ValidatePowerShellSyntax">

    <Message Text="" Importance="high" />
    <Message Text="ðŸ“‹ PowerShell 7.5.2 Validation Summary:" Importance="high" />
    <Message Text="   â€¢ Progressive mode: Only new/modified scripts validated" Importance="high" />
    <Message Text="   â€¢ Legacy scripts exempted for gradual adoption" Importance="high" />
    <Message Text="   â€¢ Parallel processing patterns verified" Importance="high" />
    <Message Text="   â€¢ Error handling requirements enforced" Importance="high" />
    <Message Text="   â€¢ Cross-platform compatibility checked" Importance="high" />
    <Message Text="   â€¢ BusBuddy integration standards validated" Importance="high" />
    <Message Text="" Importance="high" />

  </Target>

</Project>
